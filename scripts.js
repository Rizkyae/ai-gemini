document.addEventListener("DOMContentLoaded",()=>{var e=document.getElementById("send-btn");const m=document.getElementById("user-input"),u=document.getElementById("chat-box"),n=document.getElementById("history-list");var t=document.getElementById("new-chat-btn"),a=document.getElementById("clear-history-btn"),i=document.getElementById("upload-doc-btn"),s=document.getElementById("upload-img-btn");const l=document.getElementById("image-input"),r=document.getElementById("doc-input"),o=document.getElementById("file-preview-container");var d=document.getElementById("ai-model-select");const p="AIzaSyBco_NWz7SagOZ2YMC7CyFXUMg0e_yajv4";let g=d.value,h=[],b=null,f=null;function c(){localStorage.setItem("ai-chat-history",JSON.stringify(h))}function y(){n.innerHTML="",0===h.length?n.innerHTML='<li><a href="#" class="disabled">Tidak ada riwayat</a></li>':h.forEach(t=>{var e=document.createElement("li"),a=document.createElement("a");a.href="#",a.innerHTML='<i class="far fa-comment-dots"></i> '+t.title,a.dataset.chatId=t.id,t.id===b&&a.classList.add("active"),a.addEventListener("click",e=>{e.preventDefault(),b=t.id,v(),y()}),e.appendChild(a),n.appendChild(e)})}function v(){u.innerHTML="";var e,t,a=h.find(e=>e.id===b);a&&0!==a.messages.length||((e=document.createElement("div")).classList.add("message-row","bot"),(t=document.createElement("img")).src="anim.gif",t.alt="AI Avatar",t.classList.add("avatar"),e.appendChild(t),(t=document.createElement("div")).classList.add("chat-message","bot"),t.innerHTML="<p>Halo! Saya Mas Riski. Anda bisa bertanya atau mengirimkan file kepada saya.</p>",e.appendChild(t),u.appendChild(e)),a&&a.messages&&a.messages.forEach(e=>{C(e.content,e.sender,0,e.filePreview,e.fileObject,e.aiImageURL,e.timestamp)})}function w(){var e="chat-"+Date.now(),t={id:e,title:"Chat Baru",messages:[]};h.unshift(t),b=e,m.value="",E(),v(),y(),c()}function k(e,t,a="text",n=null,i=null,s=null,l=null){let r=h.find(e=>e.id===b);r||(w(),r=h.find(e=>e.id===b)),r.messages.push({sender:t,content:e,type:a,filePreview:n,fileObject:i,aiImageURL:s,timestamp:l||(new Date).toISOString()}),1===r.messages.length&&(r.title=e?e.substring(0,30)+(30<e.length?"...":""):i?`File: ${i.name.substring(0,20)}...`:"Chat Baru",y()),c()}function E(){f=null,o.innerHTML=""}function I(e){const n=e.target.files[0];if(n)if(5242880<n.size)alert("Ukuran file terlalu besar! Maksimal 5MB.");else{const i=new FileReader;i.onloadend=()=>{var e,t,a=i.result.split(",")[1];a={name:n.name,mimeType:n.type,base64:a},E(),f=a,(e=document.createElement("div")).className="file-preview-item",a.mimeType.startsWith("image/")?((t=document.createElement("img")).src=`data:${a.mimeType};base64,`+a.base64,e.appendChild(t)):e.innerHTML=`<i class="fas fa-file-alt" style="font-size: 40px; color: #888;"></i><p style="margin:0 10px;">${a.name}</p>`,(t=document.createElement("button")).className="remove-file-btn",t.innerHTML="×",t.onclick=E,e.appendChild(t),o.appendChild(e)},i.readAsDataURL(n),e.target.value=""}}const L="AIzaSyC6Fl1VhgNkqlPr3nN17XRBzFv6ZHptiBw";function C(e,t,a,n=null,i=null,s=null,l=null){var r=document.createElement("div"),o=(r.classList.add("message-row",t),document.createElement("img")),o=("bot"===t?(o.src="anim.gif",o.alt="AI Avatar"):(o.src="user.gif",o.alt="User Avatar"),o.classList.add("avatar"),r.appendChild(o),document.createElement("div"));o.classList.add("chat-message",t);let d="";n&&"user"===t&&((i?i.mimeType.startsWith("image/"):n.startsWith("data:image/"))?d+=`<div class="sent-file-preview"><img src="${n}" alt="Pratinjau Gambar"></div>`:(n=i?i.name:"Dokumen",d+=`<div class="sent-file-preview-doc"><i class="fas fa-file-alt"></i><span>${n}</span></div>`)),s&&"bot"===t&&(d+=`<div class="ai-image-response"><img src="${s}" alt="Gambar dari AI"></div>`),e&&(i=e.replace(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([\w-]{11})(?:\S+)?/g,(e,t)=>`<div class="youtube-embed-wrapper"><iframe src="https://www.youtube.com/embed/${t}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`),d+=marked.parse(i)),o.innerHTML=d;n=document.createElement("span"),t=l?new Date(l):new Date;n.classList.add("message-time"),n.textContent=t.toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}),o.appendChild(n),r.appendChild(o),u.appendChild(r),u.scrollTop=u.scrollHeight}async function A(){var a=m.value.trim();if(""!==a||f){null===b&&w();var t=f?`data:${f.mimeType};base64,`+f.base64:null,n=(new Date).toISOString(),t=(k(a,"user","text",t,f,null,n),C(a,"user",0,t,f,null,n),m.value="",E(),"lagi mikir bentar..."),n=(C(t,"bot"),h.find(e=>e.id===b)),i=[];let e="";"gen-z"===g?e="React as Riski, your AI bestie. Your personality is super chill, helpful, and you talk like a true Gen Z from Indonesia. Use casual Indonesian and mix in English slang (e.g., 'literally', 'spill', 'no cap', 'YGY', 'bestie'). Use emojis. Always keep the previous conversation in mind. Jika diminta 'berikan gambar', respons dengan teks dan URL gambar placeholder, contohnya: 'Nih, bestie, ada gambar bagus buat kamu! [GAMBAR: https://placehold.co/400x300.png?text=Contoh+Gambar+AI]'.":"normal"===g&&(e="You are Mas Riski, a helpful and friendly AI assistant. Respond in clear, concise, and polite Indonesian. Be polite, formal where appropriate, and do not use slang or emojis unless explicitly asked. Always keep the previous conversation in mind. Jika diminta 'berikan gambar', respons dengan teks dan URL gambar placeholder, contohnya: 'Baik, ini adalah contoh gambar yang saya temukan: [GAMBAR: https://placehold.co/400x300.png?text=Contoh+Gambar+AI]'."),e&&i.push({role:"user",parts:[{text:e}]});for(const o of n&&n.messages?n.messages.slice(-10):[]){var s=[];let e=o.content;var l=[...(o.content||"").matchAll(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?v=|embed\/|v\/)|youtu\.be\/)([\w-]{11})(?:\S+)?/g)];if(0<l.length)for(const d of l){var r=await async function(e){try{var t,a,n,i=await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${e}&key=`+L);if(i.ok)return(a=await i.json()).items&&0<a.items.length?{title:(n=a.items[0].snippet).title,description:n.description,tags:n.tags}:null;throw t=await i.json(),console.error("YouTube API Error Response:",t),new Error("HTTP error! status: "+i.status)}catch(e){return console.error("Error fetching YouTube video details:",e),null}}(d[1]);r&&(e=(e||"")+`

[INFO VIDEO YOUTUBE: Judul: "${r.title}", Deskripsi: "${r.description?r.description.substring(0,Math.min(r.description.length,100))+"...":"Tidak ada deskripsi."}"]`)}e&&s.push({text:e}),o.fileObject&&s.push({inline_data:{mime_type:o.fileObject.mimeType,data:o.fileObject.base64}}),0<s.length&&i.push({role:"user"===o.sender?"user":"model",parts:s})}n=await async function(e){let t;t="gen-z"===g?"gemini-1.5-flash":"normal"===g?"gemini-2.5-flash":"gemini-pro";try{var a,n,i=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${t}:generateContent?key=`+p,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:e})});if(i.ok)return(n=await i.json()).candidates&&0<n.candidates.length&&n.candidates[0].content.parts[0].text?n.candidates[0].content.parts[0].text.trim():"Maaf, saya tidak dapat memberikan respons yang valid.";throw a=await i.json(),console.error("API Error Response:",a),new Error("HTTP error! status: "+i.status)}catch(e){return console.error("Error fetching AI response:",e),"Waduh, sorry banget bro. Gagal nyambung nih, coba ganti model AI"}}(i);if(u.lastChild&&u.lastChild.querySelector(".chat-message")&&u.lastChild.querySelector(".chat-message").textContent===t&&u.removeChild(u.lastChild),a.toLowerCase().includes("edit foto")||a.toLowerCase().includes("ganti background")){t="Wah bestie, aku belum bisa bantu edit-edit foto gitu. Aku cuma bisa bantuin ngobrol, kasih info, atau analisis gambar/dokumen aja. Kalau mau edit foto, coba pake aplikasi editing foto khusus ya! 🙏";const c=(new Date).toISOString();k(t,"bot","text",null,null,null,c),void C(t,"bot",0,null,null,null,c)}else{let e=n,t=null;a=/\[GAMBAR:\s*(https?:\/\/[^\s\]]+\.(?:png|jpe?g|gif|webp|svg))\]/i;const d=n.match(a),c=(d&&d[1]&&(t=d[1],e=n.replace(a,"").trim()),(new Date).toISOString());k(e,"bot","text",null,null,t,c),C(e,"bot",0,null,null,t,c)}}}e.addEventListener("click",A),m.addEventListener("keypress",e=>{"Enter"===e.key&&A()}),t.addEventListener("click",w),i.addEventListener("click",()=>r.click()),s.addEventListener("click",()=>l.click()),l.addEventListener("change",I),r.addEventListener("change",I),a.addEventListener("click",()=>{confirm("Apakah anda yakin ingin menghapus pesan ini?!")&&(h=[],localStorage.removeItem("ai-chat-history"),b=null,w(),console.log("Riwayat obrolan telah dihapus!"))}),d.addEventListener("change",e=>{g=e.target.value,console.log("Model AI diubah menjadi: "+g)}),e=localStorage.getItem("ai-chat-history"),0<(h=e?JSON.parse(e):h).length?b=h[0].id:w(),y(),v()});
